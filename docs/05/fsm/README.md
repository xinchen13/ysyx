# 状态机及键盘输入
## PS/2 接口控制器及键盘输入
PS/2 是串行 I/O 接口的一种标准

## PS/2 接口的工作时序
PS/2 接口使用两根信号线，一根信号线传输时钟 `PS2_CLK`，另一根传输数据 `PS2_DAT`. 时钟信号主要用于指示数据线上的比特位在什么时候是有效的. 当 `PS2_DAT` 和 `PS2_CLK` 信号线都为高电平 (空闲) 时，键盘才可以给主机发送信号. 如果主机将 `PS2_CLK` 信号置低，键盘将准备接受主机发来的命令. 在实验中，主机不需要发命令，只需将这两根信号线做为输入即可

当用户按键或松开时，键盘以每帧11位的格式串行传送数据给主机，同时在 `PS2_CLK` 时钟信号上传输对应的时钟 (一般为 10.0–16.7 kHz) 第一位是开始位 (逻辑0)，后面跟8位数据位 (低位在前)，一个奇偶校验位 (奇校验) 和一位停止位 (逻辑1). 每位都在时钟的下降沿有效，主要原因是下降沿正好在数据位的中间，因此可以让数据位从开始变化到接收采样时能有一段信号建立时间

键盘通过 `PS2_DAT` 引脚发送的信息称为扫描码，每个扫描码可以由单个数据帧或连续多个数据帧构成. 当按键被按下时送出的扫描码被称为通码 (Make Code)，当按键被释放时送出的扫描码称为断码 (Break Code). 以 `W` 键为例，`W` 键的通码是 `1Dh`，如果 `W` 键被按下，则 `PS2_DAT` 引脚将输出一帧数据，其中的8位数据位为 `1Dh`，如果 `W` 键一直没有释放，则不断输出扫描码 `1Dh 1Dh … 1Dh`，直到有其他键按下或者 `W` 键被放开. 某按键的断码是 `F0h` 加此按键的通码，如释放 `W` 键时输出的断码为 `F0h 1Dh`，分两帧传输. 多个键被同时按下时，将逐个输出扫描码，如: 先按左 `Shift` 键（扫描码为 `12h`）、再按 `W` 键、放开 `W` 键、再放开左 `Shift` 键，则此过程送出的全部扫描码为: `12h 1Dh F0h 1Dh F0h 12h`

键盘通码如下所示:

<img src="../figs/Screenshot from 2024-04-09 16-07-31.png" width="500" />

## 实验: 实现单个按键的ASCII码显示
- 七段数码管低两位显示当前按键的键码，中间两位显示对应的 ASCII 码 (转换可以考虑自行设计一个 ROM 并初始化). 只需完成字符和数字键的输入，不需要实现组合键和小键盘
- 当按键松开时，七段数码管的低四位全灭
- 七段数码管的高两位显示按键的总次数. 按住不放只算一次按键. 只考虑顺序按下和放开的情况，不考虑同时按多个键的情况
- (选做) 支持 Shift，CTRL 等组合键，在 LED 上显示组合键是否按下的状态指示
- (选做) 支持 Shift 键与字母/数字键同时按下，相互不冲突
- (选做) 支持输入大写字符，显示对应的 ASCII 码 

实现如下:

- 接收 ps2 数据并翻译为扫描码的模块: [ps2_keyboard.v](./vsrc/ps2_keyboard.v)
- [segment_hex.v](./vsrc/segment_hex.v) 为数码管显示，添加了使能信号 en
- [rom.v](./vsrc/rom.v) 保存了部分按键的扫描码与对应的 ascii 码
- 顶层模块 [top.v](./vsrc/top.v)
- C++ wrapper [sim_main.cpp](./csrc/sim_main.cpp)
- [Makefile](./Makefile)
- 管脚约束: [top.nxdc](./constr/top.nxdc)

